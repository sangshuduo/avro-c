name: Codecov
on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install packages
        run: sudo apt-get install lzma-dev libjansson-dev libsnappy-dev

      - name: Test
        run: |
          mkdir debug
          cd debug
          cmake .. -DCOVER=true
          make
          ./build/bin/avrotool -w ../out.avro -m ../sampledata/schema.json -d ../sampledata/data.csv
          ./build/bin/avrotool -r ../out.avro
          gcov -abcfu ../src/avrotool.c -o src/CMakeFiles/avrotool.dir/avrotool.c.gcno
      - name: Upload
        uses: codecov/codecov-action@v2.1.0
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: debug/avrotool.c.gcov
